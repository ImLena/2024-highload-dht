# Этап 1. HTTP + storage

## Нагрузочное тестирование с использлванием wrk2

Параметры:
- Длительность 30 секунд
- Число потоков 1
- Число соединений 1

### PUT
Опытным путем найдем точку разладки для PUT запроса, чтобы положить сервер
![image](data/mk-finish-him.jpg)
```
wrk2 -d 30 -t 1 -c 1 -R 1100 -L -s /Users/lena/2024-highload-dht/src/main/java/ru/vk/itmo/test/elenakhodosova/lua_scripts/put.lua http://127.0.0.1:8080
Running 30s test @ http://127.0.0.1:8080
  1 threads and 1 connections
  Thread calibration: mean lat.: 1.067ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.08ms  469.33us  16.34ms   76.28%
    Req/Sec     1.18k   100.11     2.70k    80.77%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.07ms
 75.000%    1.40ms
 90.000%    1.59ms
 99.000%    1.74ms
 99.900%    3.01ms
 99.990%   14.76ms
 99.999%   16.35ms
100.000%   16.35ms

#[Mean    =        1.078, StdDeviation   =        0.469]
#[Max     =       16.344, Total count    =        21993]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  32999 requests in 30.00s, 2.11MB read
Requests/sec:   1099.96
Transfer/sec:     71.97KB

```
Примерно при 1100 RPS сервер перестает справляться с нагрузкой.

Проанализируем работу сервера при 1000 RPS в течение 60 секунд:
```
wrk2 -d 60 -t 1 -c 1 -R 1000 -L -s /Users/lena/2024-highload-dht/src/main/java/ru/vk/itmo/test/elenakhodosova/lua_scripts/put.lua http://127.0.0.1:8080
Running 1m test @ http://127.0.0.1:8080
  1 threads and 1 connections
  Thread calibration: mean lat.: 1.028ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.04ms  418.99us  15.83ms   71.51%
    Req/Sec     1.07k    89.70     2.40k    82.49%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.03ms
 75.000%    1.32ms
 90.000%    1.50ms
 99.000%    1.65ms
 99.900%    4.07ms
 99.990%   12.70ms
 99.999%   15.84ms
100.000%   15.84ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.096     0.000000            1         1.00
       0.558     0.100000         5022         1.11
       0.677     0.200000        10025         1.25
       0.794     0.300000        15005         1.43
       0.912     0.400000        20024         1.67
       1.027     0.500000        25008         2.00
       1.087     0.550000        27507         2.22
       1.146     0.600000        30013         2.50
       1.206     0.650000        32515         2.86
       1.264     0.700000        35033         3.33
       1.321     0.750000        37511         4.00
       1.352     0.775000        38791         4.44
       1.381     0.800000        40022         5.00
       1.410     0.825000        41250         5.71
       1.441     0.850000        42512         6.67
       1.471     0.875000        43751         8.00
       1.486     0.887500        44404         8.89
       1.501     0.900000        45012        10.00
       1.517     0.912500        45637        11.43
       1.532     0.925000        46249        13.33
       1.547     0.937500        46876        16.00
       1.555     0.943750        47193        17.78
       1.563     0.950000        47506        20.00
       1.572     0.956250        47840        22.86
       1.580     0.962500        48134        26.67
       1.590     0.968750        48455        32.00
       1.595     0.971875        48593        35.56
       1.602     0.975000        48771        40.00
       1.609     0.978125        48903        45.71
       1.617     0.981250        49068        53.33
       1.625     0.984375        49230        64.00
       1.631     0.985938        49296        71.11
       1.638     0.987500        49371        80.00
       1.647     0.989062        49453        91.43
       1.655     0.990625        49527       106.67
       1.670     0.992188        49607       128.00
       1.679     0.992969        49646       142.22
       1.688     0.993750        49684       160.00
       1.702     0.994531        49723       182.86
       1.727     0.995313        49761       213.33
       1.749     0.996094        49801       256.00
       1.763     0.996484        49822       284.44
       1.774     0.996875        49839       320.00
       1.801     0.997266        49860       365.71
       1.836     0.997656        49878       426.67
       1.917     0.998047        49898       512.00
       1.974     0.998242        49908       568.89
       2.363     0.998437        49917       640.00
       2.659     0.998633        49927       731.43
       3.401     0.998828        49937       853.33
       4.283     0.999023        49948      1024.00
       4.463     0.999121        49952      1137.78
       5.071     0.999219        49956      1280.00
       5.551     0.999316        49961      1462.86
       6.191     0.999414        49966      1706.67
       6.783     0.999512        49971      2048.00
       7.207     0.999561        49974      2275.56
       7.699     0.999609        49976      2560.00
       8.067     0.999658        49978      2925.71
       8.623     0.999707        49981      3413.33
       9.535     0.999756        49983      4096.00
      10.455     0.999780        49985      4551.11
      10.887     0.999805        49986      5120.00
      11.375     0.999829        49987      5851.43
      11.807     0.999854        49988      6826.67
      12.287     0.999878        49989      8192.00
      12.703     0.999890        49990      9102.22
      13.183     0.999902        49991     10240.00
      13.183     0.999915        49991     11702.86
      13.567     0.999927        49992     13653.33
      13.567     0.999939        49992     16384.00
      14.095     0.999945        49993     18204.44
      14.095     0.999951        49993     20480.00
      14.095     0.999957        49993     23405.71
      15.007     0.999963        49994     27306.67
      15.007     0.999969        49994     32768.00
      15.007     0.999973        49994     36408.89
      15.007     0.999976        49994     40960.00
      15.007     0.999979        49994     46811.43
      15.839     0.999982        49995     54613.33
      15.839     1.000000        49995          inf
#[Mean    =        1.036, StdDeviation   =        0.419]
#[Max     =       15.832, Total count    =        49995]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  60000 requests in 1.00m, 3.83MB read
Requests/sec:    999.99
Transfer/sec:     65.43KB
```

### GET
Для GET запроса ситуация немного лучше: нагрузка в 1300 RPS за 30 секунд убивает сервер, но с 1200 RPS железо уже справляется и может держать стабильно 60 секунд.
```
 lena@Khodosovas-MacBook-Air Downloads % wrk2 -d 30 -t 1 -c 1 -R 1300 -L -s /Users/lena/2024-highload-dht/src/main/java/ru/vk/itmo/test/elenakhodosova/lua_scripts/get.lua http://127.0.0.1:8080
Running 30s test @ http://127.0.0.1:8080
  1 threads and 1 connections
  Thread calibration: mean lat.: 0.999ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.00ms  447.58us   3.95ms   62.81%
    Req/Sec     1.38k    87.27     1.78k    85.25%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    1.00ms
 75.000%    1.30ms
 90.000%    1.64ms
 99.000%    1.84ms
 99.900%    1.98ms
 99.990%    3.18ms
 99.999%    3.95ms
100.000%    3.95ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.056     0.000000            1         1.00
       0.357     0.100000         2601         1.11
       0.591     0.200000         5202         1.25
       0.768     0.300000         7817         1.43
       0.887     0.400000        10413         1.67
       1.003     0.500000        13002         2.00
       1.063     0.550000        14310         2.22
       1.119     0.600000        15605         2.50
       1.178     0.650000        16910         2.86
       1.236     0.700000        18201         3.33
       1.303     0.750000        19497         4.00
       1.355     0.775000        20144         4.44
       1.411     0.800000        20800         5.00
       1.475     0.825000        21455         5.71
       1.531     0.850000        22107         6.67
       1.584     0.875000        22751         8.00
       1.611     0.887500        23074         8.89
       1.643     0.900000        23398        10.00
       1.677     0.912500        23721        11.43
       1.713     0.925000        24055        13.33
       1.739     0.937500        24376        16.00
       1.751     0.943750        24533        17.78
       1.761     0.950000        24702        20.00
       1.772     0.956250        24866        22.86
       1.782     0.962500        25023        26.67
       1.793     0.968750        25190        32.00
       1.797     0.971875        25262        35.56
       1.804     0.975000        25355        40.00
       1.809     0.978125        25430        45.71
       1.815     0.981250        25505        53.33
       1.823     0.984375        25590        64.00
       1.826     0.985938        25630        71.11
       1.831     0.987500        25669        80.00
       1.835     0.989062        25713        91.43
       1.841     0.990625        25751       106.67
       1.847     0.992188        25790       128.00
       1.852     0.992969        25812       142.22
       1.856     0.993750        25830       160.00
       1.864     0.994531        25852       182.86
       1.871     0.995313        25871       213.33
       1.882     0.996094        25893       256.00
       1.886     0.996484        25901       284.44
       1.894     0.996875        25910       320.00
       1.898     0.997266        25920       365.71
       1.905     0.997656        25933       426.67
       1.916     0.998047        25941       512.00
       1.926     0.998242        25946       568.89
       1.932     0.998437        25951       640.00
       1.938     0.998633        25956       731.43
       1.953     0.998828        25961       853.33
       1.982     0.999023        25966      1024.00
       2.014     0.999121        25969      1137.78
       2.020     0.999219        25971      1280.00
       2.024     0.999316        25974      1462.86
       2.055     0.999414        25976      1706.67
       2.097     0.999512        25979      2048.00
       2.125     0.999561        25981      2275.56
       2.125     0.999609        25981      2560.00
       2.163     0.999658        25983      2925.71
       2.657     0.999707        25984      3413.33
       2.703     0.999756        25985      4096.00
       2.761     0.999780        25986      4551.11
       2.761     0.999805        25986      5120.00
       2.939     0.999829        25987      5851.43
       3.179     0.999854        25988      6826.67
       3.179     0.999878        25988      8192.00
       3.305     0.999890        25989      9102.22
       3.305     0.999902        25989     10240.00
       3.305     0.999915        25989     11702.86
       3.369     0.999927        25990     13653.33
       3.369     0.999939        25990     16384.00
       3.369     0.999945        25990     18204.44
       3.369     0.999951        25990     20480.00
       3.369     0.999957        25990     23405.71
       3.949     0.999963        25991     27306.67
       3.949     1.000000        25991          inf
#[Mean    =        1.003, StdDeviation   =        0.448]
#[Max     =        3.948, Total count    =        25991]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  38999 requests in 30.00s, 4.31MB read
Requests/sec:   1299.92
Transfer/sec:    147.11KB
```
```wrk2 -d 60 -t 1 -c 1 -R 1200 -L -s /Users/lena/2024-highload-dht/src/main/java/ru/vk/itmo/test/elenakhodosova/lua_scripts/get.lua http://127.0.0.1:8080
Running 1m test @ http://127.0.0.1:8080
  1 threads and 1 connections
  Thread calibration: mean lat.: 0.985ms, rate sampling interval: 10ms
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     0.99ms  465.06us   8.54ms   65.86%
    Req/Sec     1.27k   101.36     2.00k    76.59%
  Latency Distribution (HdrHistogram - Recorded Latency)
 50.000%    0.99ms
 75.000%    1.30ms
 90.000%    1.62ms
 99.000%    1.80ms
 99.900%    3.13ms
 99.990%    6.86ms
 99.999%    8.06ms
100.000%    8.55ms

  Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)

       0.058     0.000000            2         1.00
       0.312     0.100000         6034         1.11
       0.629     0.200000        12014         1.25
       0.755     0.300000        18019         1.43
       0.869     0.400000        24049         1.67
       0.989     0.500000        30025         2.00
       1.046     0.550000        33043         2.22
       1.103     0.600000        36030         2.50
       1.162     0.650000        39033         2.86
       1.224     0.700000        42028         3.33
       1.299     0.750000        45022         4.00
       1.356     0.775000        46522         4.44
       1.427     0.800000        48007         5.00
       1.490     0.825000        49509         5.71
       1.542     0.850000        51001         6.67
       1.583     0.875000        52527         8.00
       1.600     0.887500        53261         8.89
       1.619     0.900000        54038        10.00
       1.637     0.912500        54752        11.43
       1.656     0.925000        55500        13.33
       1.677     0.937500        56258        16.00
       1.687     0.943750        56629        17.78
       1.698     0.950000        57011        20.00
       1.708     0.956250        57381        22.86
       1.720     0.962500        57760        26.67
       1.733     0.968750        58141        32.00
       1.739     0.971875        58310        35.56
       1.746     0.975000        58514        40.00
       1.754     0.978125        58714        45.71
       1.762     0.981250        58874        53.33
       1.772     0.984375        59079        64.00
       1.777     0.985938        59164        71.11
       1.784     0.987500        59256        80.00
       1.791     0.989062        59342        91.43
       1.802     0.990625        59437       106.67
       1.816     0.992188        59531       128.00
       1.827     0.992969        59576       142.22
       1.838     0.993750        59624       160.00
       1.854     0.994531        59669       182.86
       1.870     0.995313        59716       213.33
       1.898     0.996094        59761       256.00
       1.919     0.996484        59785       284.44
       1.959     0.996875        59808       320.00
       2.005     0.997266        59831       365.71
       2.073     0.997656        59855       426.67
       2.183     0.998047        59878       512.00
       2.331     0.998242        59890       568.89
       2.517     0.998437        59902       640.00
       2.667     0.998633        59913       731.43
       2.909     0.998828        59925       853.33
       3.371     0.999023        59937      1024.00
       3.585     0.999121        59945      1137.78
       3.691     0.999219        59950      1280.00
       3.853     0.999316        59954      1462.86
       4.323     0.999414        59960      1706.67
       4.531     0.999512        59966      2048.00
       4.983     0.999561        59969      2275.56
       5.095     0.999609        59972      2560.00
       5.451     0.999658        59975      2925.71
       5.711     0.999707        59978      3413.33
       5.891     0.999756        59981      4096.00
       5.955     0.999780        59982      4551.11
       6.239     0.999805        59984      5120.00
       6.511     0.999829        59985      5851.43
       6.663     0.999854        59987      6826.67
       6.667     0.999878        59988      8192.00
       6.859     0.999890        59989      9102.22
       7.019     0.999902        59990     10240.00
       7.019     0.999915        59990     11702.86
       7.139     0.999927        59991     13653.33
       7.343     0.999939        59992     16384.00
       7.343     0.999945        59992     18204.44
       7.447     0.999951        59993     20480.00
       7.447     0.999957        59993     23405.71
       7.447     0.999963        59993     27306.67
       8.063     0.999969        59994     32768.00
       8.063     0.999973        59994     36408.89
       8.063     0.999976        59994     40960.00
       8.063     0.999979        59994     46811.43
       8.063     0.999982        59994     54613.33
       8.551     0.999985        59995     65536.00
       8.551     1.000000        59995          inf
#[Mean    =        0.993, StdDeviation   =        0.465]
#[Max     =        8.544, Total count    =        59995]
#[Buckets =           27, SubBuckets     =         2048]
----------------------------------------------------------
  72000 requests in 1.00m, 7.96MB read
Requests/sec:   1199.98
Transfer/sec:    135.80KB
```
/* To be continued */